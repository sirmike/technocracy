# General configuration

## server tokens
`server_tokens            off;`

# SSl/TLS Theory

## Symmetric cryptography
The same key is used either for encryption or decryption

## Asymmetric cryptography
Only one of a key pair (public / private) is used for encryption / decryption

## Sample TLS/SSL session
https://blog.hartleybrody.com/https-certificates/

### Handshake

```
CLIENT                                         SERVER

                     client hello
protocol version         ->
session ID (optional)    ->
ciphers                  ->
compression algorithms   ->

                     server hello
                         <-             ciphers with protocol that server will use
                         <-             session ID
                         <-             certificate
                         <-             client cert request (optional)
                         
           client verifies server's certificate
                
                         ->
            client sends secret symmetric key
           (encrypted with server's public key)
           
                         ->
              (optional client certificate)
              
                   HANDSHAKE FINISH
                   
       EXCHANGING MESSAGES USING SECRET SYMMETRIC KEY
```

### Diffie-Hellman explained

https://pl.wikipedia.org/wiki/Pierwiastek_pierwotny

Pierwiastek pierwotny modulo n to taka liczba, że jej potęgi dają wszystkie możliwe reszty modulo n które są względnie pierwsze z n

`(G ^ private) mod (P)`

```
G = primitive root modulo n = 3
P = prime number = 17
n = private
```

```
Alice's mixture = 3 ^ 15 % 17 = 6
Bob's mixture = 3 ^ 13 % 17 = 12
```

They publicly exchange that result

```
Alice calculates a secret = (Bob’s mixture ^ Alice’s Secret) % prime
Bob calculates a secret = (Alice’s mixture ^ Bob’s Secret) % prime

secret = (12 ^ 15) % 17 = 10
secret = (6 ^ 13) % 17 = 10
```

### How to generate DH params

```
# openssl dhparam -2 2048 -text
..............................+...............................................................................................................................................+........................................+............................................................................................................................................................................................+...............+............................................................................................+.......................+..................................................................................................+.............................................................................................................................................................................................+...........................................................................................................+...+................................................................................................................................................+............................................+..................................................................................+...........................................................................................................................................................+.....................................................................................................................+.................................................................................................................................................+.............+..................+..........................................................................................................................................................................................................................................+...............................................................+....................................................................................+.....................................................................................................................................................................................................................+........................................................................................................................+........+........................................................+............................................+.........................................................................................................................................................................................................................................................................................................................+..+...........................................................................................................................................+.....................+.................................+......................................+............................................................................................................................+...........................+................................................................................................................................................................................................................................................................................................................................+.......................................................+........................+...............................................................................................................................................+.......+..................+.......................................................................+....................................+....................................................................................................................................................................................................................+............+...........................+........................................................................................................+..........................................................................................................................................................................................................................................................................+...........................................................................................................................+.......+....................................................................+.....+..............................................................................................................................................................................................................................+..................................................+...................................................................................+..............................................................................................................................................................................................+.......................+..........................+..............................................+....................+.............................................+........................................................................+.........++*++*
    DH Parameters: (2048 bit)
        prime:
            00:ee:c0:27:93:e1:64:0d:cd:6a:31:cd:30:79:7e:
            20:d7:8a:74:1a:db:a2:36:d2:87:c7:68:fb:5d:93:
            77:27:3d:09:e8:8c:08:54:11:84:57:a7:ad:e9:89:
            c8:af:1d:f1:f2:37:0a:8a:76:bc:28:02:c3:1d:72:
            4c:7a:95:2a:a9:5b:90:cd:9a:24:30:af:b8:0b:42:
            38:14:38:bf:3c:62:0a:1a:f4:a8:96:55:38:73:7f:
            9f:56:d6:6f:bf:aa:d6:c3:f3:4e:58:b1:b0:1f:6d:
            d1:b8:42:e2:32:1a:57:f5:0e:a9:37:4d:d8:86:f9:
            5d:b0:fc:d9:83:b0:b6:e7:e2:04:00:f5:33:d9:ba:
            4c:bf:e6:d3:2a:80:3f:03:3d:47:6a:6a:71:8b:e7:
            5f:d0:fe:52:76:92:71:bd:95:bc:2b:87:85:c1:7b:
            76:ec:2e:9e:10:43:c4:c1:09:b7:2c:33:6e:43:b9:
            14:fc:a4:64:ac:a6:57:6f:d6:6a:87:6d:95:cf:d3:
            0b:06:a1:e4:cb:f5:81:84:ea:4c:5d:1c:dd:da:77:
            13:77:15:69:0d:43:62:d0:4a:01:9a:69:98:2e:cd:
            13:54:1e:e3:79:00:68:de:54:bf:55:f0:31:24:26:
            f6:0f:5a:06:11:e8:56:62:da:e1:d8:0c:af:9a:a8:
            d9:4b
        generator: 2 (0x2)
-----BEGIN DH PARAMETERS-----
MIIBCAKCAQEA7sAnk+FkDc1qMc0weX4g14p0GtuiNtKHx2j7XZN3Jz0J6IwIVBGE
V6et6YnIrx3x8jcKina8KALDHXJMepUqqVuQzZokMK+4C0I4FDi/PGIKGvSollU4
c3+fVtZvv6rWw/NOWLGwH23RuELiMhpX9Q6pN03YhvldsPzZg7C25+IEAPUz2bpM
v+bTKoA/Az1Hampxi+df0P5SdpJxvZW8K4eFwXt27C6eEEPEwQm3LDNuQ7kU/KRk
rKZXb9Zqh22Vz9MLBqHky/WBhOpMXRzd2ncTdxVpDUNi0EoBmmmYLs0TVB7jeQBo
3lS/VfAxJCb2D1oGEehWYtrh2AyvmqjZSwIBAg==
-----END DH PARAMETERS-----
```

# SSL in nginx

## general server config

```
ssl_protocols             TLSv1.2;
ssl_ciphers               'EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH';
ssl_prefer_server_ciphers on;
ssl_dhparam               dhparams.pem;
```


## session resumption (caching)
`ssl_session_cache         shared:SSL:10m;`

* a cache shared between all worker processes
* one megabyte can store about 4000 sessions
* a cache with the same name can be used in several virtual servers.

## virtual host specific

```
ssl                       on;
ssl_certificate           /foo/bar.pem;
ssl_certificate_key       /foo/bar.key;
```

### full certificate chain bundle in .pem format

```
-----BEGIN CERTIFICATE-----
... signed certificate
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
... intermediate root certificate
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
... root certificate
-----END CERTIFICATE-----
```

## OCSP stapling (Online Certificate Status Protocol)

```
ssl_stapling              on;
ssl_stapling_verify       on;
```

https://blog.mozilla.org/security/2013/07/29/ocsp-stapling-in-firefox/